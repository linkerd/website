---
title: Automatically Rotating Control Plane TLS Credentials
description: Use cert-manager to automatically rotate control plane TLS credentials.
---

Linkerd's [automatic mTLS](../../features/automatic-mtls/), like any mTLS
implementation, relies on properly-configured _certificates_ as the basis of
identity within the mesh. Each meshed workload has its own _workload
certificate_ generated by Linkerd itself from a *trust anchor*, which can be
shared across clusters, and an *identity issuer certificate*, which is
specific to the cluster.

{{< note >}}

Certificates are one of the most important parts of a secure system based on
mTLS, but they are also commonly one of the least well documented. For more
information about certificates in Linkerd, see the Buoyant [(m)TLS concepts
primer].

[(m)TLS concepts primer]: https://docs.buoyant.io/buoyant-enterprise-linkerd/latest/reference/tls-concepts/

{{< /note >}}

While Linkerd automatically rotates the per-proxy TLS certificates, it cannot
automatically rotate the identity issuer certificate or the trust anchor.
Linkerd's out-of-the-box installations generate static self-signed
certificates with a validity of one year but require manual rotation by the
user to prevent expiry. While this setup is convenient for quick start
testing, it's not advisable nor recommended for production environments.

{{< docs/production-note >}}

## Automating Certificate Management with cert-manager and trust-manager

[cert-manager] and [trust-manager] are popular CNCF tools that automate
certificate management for Kubernetes installations. They can work together
with Linkerd to automate rotating the identity issuer certificate and partly
automate rotating the trust anchor.

[cert-manager]: https://cert-manager.io/docs/
[trust-manager]: https://cert-manager.io/docs/trust/trust-manager/

cert-manager is _extremely_ flexible, and much of its configuration depends on
the specific policies of the organization running it. Rather than attempt to
provide a comprehensive guide to cert-manager, this document will focus on a
very simple setup:

- cert-manager will create a self-signed trust anchor;

- cert-manager will use the trust anchor to automatically manage Linkerd's
  identity issuer certificate; and

- trust-manager will create a trust bundle that Linkerd can use to verify the
  authenticity of certificates issued by cert-manager.

Once the certificates are created, cert-manager will periodically rotate them
as necessary.

{{< note >}}

cert-manager is _extremely_ flexible, with many different ways to configure
it. For more information about cert-manager in general and how to approach its
configuration, see Buoyant's [cert-manager concepts primer].

[cert-manager concepts primer]: https://docs.buoyant.io/buoyant-enterprise-linkerd/latest/reference/cert-manager-concepts/

{{< /note >}}

## Overview

The process we will follow is straightforward even though it has several
steps:

1. Create the `linkerd` namespace in which we need our Linkerd certificates to
   live
2. Install cert-manager and trust-manager on your cluster
3. Configure cert-manager to create the trust anchor
4. Configure cert-manager to use the trust anchor to create the identity
   issuer certificate
5. Configure cert-manager to create a trust bundle for Linkerd to use
6. Install Linkerd using the trust anchor and identity issuer certificate
   created by cert-manager

### 1. Create the `linkerd` namespace

This may seem a bit odd, since we haven't installed Linkerd yet! However, this
is an important first step: Linkerd expects its certificates to be in the
`linkerd` namespace, and when working with cert-manager, Linkerd needs the
certificates to already be present when it is installed. So we'll create the
namespace now:

```bash
kubectl create namespace linkerd
```

### 2. Install cert-manager and trust-manager

[cert-manager installation guide]: https://cert-manager.io/docs/installation/
[trust-manager installation guide]: https://cert-manager.io/docs/trust/trust-manager/installation/

Next up, install cert-manager (we'll use Helm for this, but you can check out
the [cert-manager installation guide] for more options):

```bash
helm repo add jetstack https://charts.jetstack.io --force-update

helm install \
  cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --set crds.enabled=true

kubectl rollout status -n cert-manager deploy
```

We strongly recommend installing cert-manager in the `cert-manager` namespace.

Once cert-manager is installed, install trust-manager (again, we'll use Helm
for this, but there are more options in the [trust-manager installation
guide]). We'll install trust-manager in the cert-manager namespace as well,
but there's an important detail here: we need to configure trust-manager to
use the `linkerd` namespace as the trust namespace. This is because Linkerd
expects its trust bundle to be in the `linkerd` namespace.

```bash
helm install \
  trust-manager jetstack/trust-manager \
  --namespace cert-manager \
  --set app.trust.namespace=linkerd \
  --wait
```

#### Give cert-manager necessary RBAC permissions

By default cert-manager will only create certificate secrets in the namespace
where it is installed. Linkerd, however, requires the cert secrets to be
created in the linkerd namespace. To do this we will create a `ServiceAccount`
for cert-manager in the linkerd namespace with the required permissions.

```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-manager
  namespace: linkerd
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cert-manager-secret-creator
  namespace: linkerd
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "get", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cert-manager-secret-creator-binding
  namespace: linkerd
subjects:
  - kind: ServiceAccount
    name: cert-manager
    namespace: linkerd
roleRef:
  kind: Role
  name: cert-manager-secret-creator
  apiGroup: rbac.authorization.k8s.io
EOF
```

### 3. Configure cert-manager to create the trust anchor

cert-manager uses _issuers_ to create _certificates_. Any certificate created
and managed by cert-manager must be configured with a Certificate resource and
must be linked to an issuer. Any issuer that cert-manager uses must be
configured with an Issuer or ClusterIssuer resource.

We'll start by creating a `ClusterIssuer` for the trust anchor, since we don't
need it to be specific to a namespace. This will be a self-signed issuer,
meaning that will simply generate self-signed certificates with random keys --
this is the simplest kind of issuer.

{{< note >}}

Your organization may have a more complex certificate authority setup, in
which case you would need to use a different kind of issuer to provide
Linkerd's trust anchor. The ClusterIssuer below is just an example; the rest
of the setup will still work if you need to change out the trust anchor
issuer.

{{< /note >}}

```bash
kubectl apply -f - <<EOF
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: linkerd-trust-root-issuer
spec:
  selfSigned: {}
EOF
```

Next, we'll create a cert-manager `Certificate` resource which uses the
previously-created `ClusterIssuer`:

```bash
kubectl apply -f - <<EOF
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: linkerd-trust-anchor
  namespace: cert-manager
spec:
  secretName: linkerd-trust-anchor
  commonName: root.linkerd.cluster.local
  isCA: true
  duration: 87600h0m0s
  renewBefore: 87264h0m0s
  issuerRef:
    name: linkerd-trust-root-issuer
    kind: ClusterIssuer
  privateKey:
    algorithm: ECDSA
EOF
```

Note that this Certificate lives in the `cert-manager` namespace. cert-manager
will write the newly-created certificate into a Secret with the name given by
the `secretName` field, in the same namespace as the Certificate. While
Linkerd needs its trust bundle to be in the `linkerd` namespace, Linkerd does
_not_ need access to the private key of the trust anchor, so it's better to
keep that Secret in the `cert-manager` namespace where Linkerd can be
prevented from accessing it.

At this point, you should see a Secret named `linkerd-trust-anchor` in the
`cert-manager` namespace:

```bash
kubectl get secret -n cert-manager linkerd-trust-anchor
```

#### 4. Configure cert-manager to use the trust anchor to create the identity issuer certificate

We now need to configure cert-manager to create the Linkerd identity issuer
certificate, which requires creating another issuer. For this, we'll use a
`CA`-type ClusterIssuer, telling cert-manager to use the trust anchor
certificate it just created to issue a second certificate.

This needs to be a ClusterIssuer because Linkerd _does_ need access to the
private key of the identity issuer certificate, so its Certificate needs to be
in the `linkerd` namespace. Using a ClusterIssuer is the simplest way to cross
namespace boundaries here.

```bash
kubectl apply -f - <<EOF
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: linkerd-identity-issuer
spec:
  ca:
    secretName: linkerd-trust-anchor
EOF
```

#### Create a Certificate resource referencing the issuer

Next, create a Linkerd identity issuer certificate which will act as an
intermediary signing CA for all Linkerd mTLS proxy certificates:

```bash
kubectl apply -f - <<EOF
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: linkerd-identity-issuer
  namespace: linkerd
spec:
  commonName: identity.linkerd.cluster.local
  dnsNames:
  - identity.linkerd.cluster.local
  isCA: true
  privateKey:
    algorithm: ECDSA
  usages:
    - cert sign
    - crl sign
    - server auth
    - client auth
  duration: 28h0m0s
  renewBefore: 25h0m0s
  issuerRef:
    name: linkerd-identity-issuer
    kind: Issuer
  privateKey:
    algorithm: ECDSA
  secretName: linkerd-identity-issuer
EOF
```

(In the YAML manifest above, the `duration` key instructs cert-manager to
consider certificates as valid for `48` hours and the `renewBefore` key
indicates that cert-manager will attempt to issue a new certificate `25` hours
before expiration of the current one. These values can be customized to your
liking.)

#### Create Linkerd trust bundle

Lastly, we will also need to create a trust bundle which will allow Linkerd's
identity controller to verify the authenticity of certificates issued by
cert-manager:

```bash
kubectl apply -f - <<EOF
apiVersion: trust.cert-manager.io/v1alpha1
kind: Bundle
metadata:
  name: linkerd-identity-trust-roots
  namespace: linkerd
spec:
  sources:
    - secret:
        name: "linkerd-trust-anchor"
        key: "ca.crt"
  target:
    configMap:
      key: "ca-bundle.crt"
EOF
```

## Summary & Validation

Below are the resources created for managing Linkerd identity certificates with
cert-manager:

- Namespace: `linkerd` (to store certificates and secrets)
- RBAC Permissions: ServiceAccount, Role, and RoleBinding in the `linkerd`
  namespace for cert-manager
- ClusterIssuer: `linkerd-trust-root-issuer` (self-signed ClusterIssuer)
- Certificate: `linkerd-trust-anchor` (in the `linkerd` namespace, referencing
  `linkerd-trust-root-issuer`)
- Issuer: `linkerd-identity-issuer` (to manage Linkerd identity certificates)
- Certificate: `linkerd-identity-issuer` (in the `linkerd` namespace, acting as
  an intermediary signing CA)
- Trust Bundle: `linkerd-identity-trust-roots` (to allow Linkerd's identity
  controller to verify certificate authenticity)

To validate creation and status, run the following commands:

```bash
# Check namespace creation
kubectl get namespaces linkerd

# Check RBAC permissions
kubectl get serviceaccount,role,rolebinding -n linkerd

# Check ClusterIssuer creation
kubectl get clusterissuers linkerd-trust-root-issuer

# Check Certificate creation
kubectl get certificates -n linkerd

# Check Issuer creation
kubectl get issuers.cert-manager.io -n linkerd

# Check Trust Bundle creation
kubectl get bundles -n linkerd
```

## Consuming cert-manager identity certificates

To have Linkerd consume cert-manager created certificates you will need to add
the following to your values file or pass them in as flags at runtime.

| Field                    | Value             |
| ------------------------ | ----------------- |
| `identity.externalCA`    | true              |
| `identity.issuer.scheme` | kubernetes.io/tls |

### Using these credentials with CLI installation

For CLI installation, the Linkerd control plane should be installed with the
`--identity-external-issuer` flag, which instructs Linkerd to read certificates
from the `linkerd-identity-issuer` secret. Whenever certificate and key stored
in the secret are updated, the `identity` service will automatically detect this
change and reload the new credentials.

Voila! We have set up automatic rotation of Linkerd's control plane TLS
credentials.

### Using these credentials with a Helm installation

For installing with Helm, first install the `linkerd-crds` chart:

```bash
helm install linkerd-crds -n linkerd --create-namespace linkerd/linkerd-crds
```

Then install the `linkerd-control-plane` chart:

```bash
helm install linkerd-control-plane -n linkerd \
  --set identity.externalCA=true \
  --set identity.issuer.scheme=kubernetes.io/tls \
  linkerd/linkerd-control-plane
```

Voila! We have set up automatic rotation of Linkerd's control plane TLS
credentials.

## Observing the update process

Once you have set up automatic rotation of Linkerd's control plane TLS
credentials, you can monitor the update process by checking the `IssuerUpdated`
events emitted by the service:

```bash
kubectl get events --field-selector reason=IssuerUpdated -n linkerd
```

## A note on third party cert management solutions

It is important to note that the mechanism that Linkerd provides for setting
issuer certificates and keys is also usable outside of cert-manager. Linkerd
will read the `linkerd-identity-issuer` Secret, and if it's of type
`kubernetes.io/tls`, will use the contents as its TLS credentials. This means
that any solution that is able to rotate TLS certificates by writing them to
this secret can be used to provide dynamic TLS certificate management.

You could generate that secret with a command such as:

```bash
kubectl create secret tls linkerd-identity-issuer --cert=issuer.crt --key=issuer.key --namespace=linkerd
```

Where `issuer.crt` and `issuer.key` would be the cert and private key of an
intermediary cert rooted at the trust root (`ca.crt`) referred above (check this
[guide](../generate-certificates/) to see how to generate them).

Note that the root cert (`ca.crt`) needs to be included in that Secret as well.
You can just edit the generated Secret and include the `ca.crt` field with the
contents of the file base64-encoded.

After setting up the `linkerd-identity-issuer` Secret, continue with the
following instructions to install and configure Linkerd to use it.

## See also

- [Automatically Rotating Webhook TLS Credentials](../automatically-rotating-webhook-tls-credentials/)
- [Manually rotating Linkerd's trust anchor credentials](../manually-rotating-control-plane-tls-credentials/)
